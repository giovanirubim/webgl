<html>
	<head>
		<title></title>
		<script type="text/javascript" src="webgl2.js"></script>
		<script type="text/javascript" src="3dbasis.js"></script>
	</head>
	<body>
		<canvas width="800" height="450"></canvas>
	</body>
</html>
<script type="text/javascript">

	let loadImg = (src, handler) => {
		let img = document.createElement("img");
		img.addEventListener("load", _=>{
			handler(img);
		});
		img.src = src;
		return img;
	};

	let loadShader = (src, type, handler) => {
		let xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (this.readyState === 4 && this.status === 200) {
				shader = new Shader();
				shader.source = this.responseText;
				shader.type = type;
				handler(shader);
			}
		};
		xhttp.open("GET", src, true);
		xhttp.send();
	};

	let cubeSize = 4;

	let geometry = new Geometry();
	let p1 = cubeSize*0.5;
	let p0 = -p1;
	let c0 = 0.2, c1 = 0.8;
	let u0 = 0.0, u1 = 1.0;

	geometry.attrArray = new Float32Array([

		p0, p0, p0,
		c0, c0, c0,
		u0, u0,

		p0, p1, p0,
		c0, c1, c0,
		u0, u1,

		p1, p1, p0,
		c1, c1, c0,
		u1, u1,

		p1, p0, p0,
		c1, c0, c0,
		u1, u0,

		p0, p0, p1,
		c0, c0, c1,
		u0, u0,

		p0, p1, p1,
		c0, c1, c1,
		u0, u1,

		p1, p1, p1,
		c1, c1, c1,
		u1, u1,

		p1, p0, p1,
		c1, c0, c1,
		u1, u0

	]);

	geometry.element = new Uint8Array([
		0, 1, 2, 0, 2, 3,
		4, 5, 6, 4, 6, 7,
		0, 1, 5, 0, 5, 4,
		3, 2, 6, 3, 6, 7,
		0, 4, 7, 0, 7, 3,
		1, 5, 6, 1, 6, 2
	]);

	function render() {
		ctx.clear();
		ctx.renderMesh(mesh, camera);
	}

	let program, material, mesh, camera, ctx, vShader, fShader, texture;
	let nLoads = 4;

	function ready() {
		if (--nLoads) return;
		program = new Program(vShader, fShader);
		material = new Material(program);
		material.addTexture(texture);
		mesh = new Mesh(geometry, material);
		mesh.localRotate(Math.PI/4, 0, Math.PI/4, "ZYX");
		mesh.translate(0, 0, 54);
		camera = new Camera(Math.atan(18/36), 16/9, 36, 72);
		ctx = new WebGL2Context();
		ctx.bindCanvas(document.querySelector("canvas"));
		render();
	}

	window.addEventListener("load", function(){
		ready();
	});

	loadImg("box.png", img=>{
		texture = new Texture(img);
		ready();
	});

	loadShader("vertex.glsl", "vertex", shader=>{
		vShader = shader;
		ready();
	})

	loadShader("fragment.glsl", "fragment", shader=>{
		fShader = shader;
		ready();
	})

</script>