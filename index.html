<html>
	<head>
		<title></title>
		<script type="text/javascript" src="webgl2.js"></script>
		<script type="text/javascript" src="3dbasis.js"></script>
	</head>
	<body>
		<canvas width="800" height="450"></canvas>
	</body>
</html>
<script type="text/javascript">

	let loadImg = (src, handler) => {
		let img = document.createElement("img");
		img.addEventListener("load", _=>{
			handler(img);
		});
		img.src = src;
		return img;
	};

	let loadShader = (src, type, handler) => {
		let xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (this.readyState === 4 && this.status === 200) {
				shader = new Shader();
				shader.source = this.responseText;
				shader.type = type;
				handler(shader);
			}
		};
		xhttp.open("GET", src, true);
		xhttp.send();
	};

	function createCubeGeometry(size) {
		let geometry = new Geometry();
		let nv = 0;
		let a = -1, b = 1;
		let face = {
			pos: [
				a, a, a,
				a, b, a,
				b, b, a,
				b, a, a
			],
			uv: [
				0, 0,
				0, 1,
				1, 1,
				1, 0
			],
			color: 0.1,
			normal: [0, 0, -1],
			n: 4,
			element: [0, 1, 2, 0, 2, 3],
		};
		let rotateObj = obj => {
			
		};
		let attrArray = [];
		let elementArray = [];
		let addObj = obj => {
			let color = obj.color;
			let normal = obj.normal;
			for (let i=0; i<obj.n; ++i) {
				attrArray.push(obj.pos[i*3 + 0]);
				attrArray.push(obj.pos[i*3 + 1]);
				attrArray.push(obj.pos[i*3 + 2]);
				attrArray.push(color);
				attrArray.push(color);
				attrArray.push(color);
				attrArray.push(obj.uv[i*2 + 0]);
				attrArray.push(obj.uv[i*2 + 1]);
				attrArray.push(normal[0]);
				attrArray.push(normal[1]);
				attrArray.push(normal[2]);
			}
			for (let i=0; i<obj.element.length; ++i) {
				elementArray.push(obj.element[i]);
			}
		};
		addObj(face);
		geometry.attrArray = new Float32Array(attrArray);
		geometry.element = new Int8Array(elementArray);
		console.log(geometry);
		return geometry;
	}

	function render() {
		ctx.clear();
		ctx.renderMesh(mesh, camera);
	}

	let program, material, mesh, camera, ctx, vShader, fShader, texture;
	let nLoads = 4;

	function ready() {
		if (--nLoads) return;
		program = new Program(vShader, fShader);
		material = new Material(program);
		material.addTexture(texture);
		mesh = new Mesh(createCubeGeometry(4), material);
		// mesh.localRotate(Math.PI/4, 0, Math.PI/4, "ZYX");
		mesh.translate(0, 0, 5);
		camera = new Camera(Math.atan(18/36), 16/9, 1, 72);
		ctx = new WebGL2Context();
		ctx.bindCanvas(document.querySelector("canvas"));
		ctx.bindTexture(texture);
		setInterval(function(){
			mesh.localRotate(0, 0.001, 0);
			render();
		}, 0);
	}

	window.addEventListener("load", function(){
		ready();
	});

	loadImg("box.png", img=>{
		texture = new Texture(img);
		ready();
	});

	loadShader("vertex.glsl", "vertex", shader=>{
		vShader = shader;
		ready();
	})

	loadShader("fragment.glsl", "fragment", shader=>{
		fShader = shader;
		ready();
	})

</script>