<html>
	<head>
		<title></title>
		<script type="text/javascript" src="webgl2.js"></script>
		<script type="text/javascript" src="3dbasis.js"></script>
	</head>
	<body>
		<canvas width="800" height="450"></canvas>
	</body>
</html>
<script type="text/javascript">

	let loadImg = (src, handler) => {
		let img = document.createElement("img");
		img.addEventListener("load", _=>{
			handler(img);
		});
		img.src = src;
		return img;
	};

	let loadShader = (src, type, handler) => {
		let xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (this.readyState === 4 && this.status === 200) {
				shader = new Shader();
				shader.source = this.responseText;
				shader.type = type;
				handler(shader);
			}
		};
		xhttp.open("GET", src, true);
		xhttp.send();
	};

	function createCubeGeometry(size) {
		let geometry = new Geometry();
		let n = 0;
		let vA = [];
		let vE = [];
		let uv = [
			{x: 0, y: 0},
			{x: 1, y: 0},
			{x: 1, y: 1},
			{x: 0, y: 1}
		];
		let addFace = (r, g, b, ry) => {
			let vPos = [
				new Vec(-1, -1, -1),
				new Vec( 1, -1, -1),
				new Vec( 1,  1, -1),
				new Vec(-1,  1, -1)
			];
			ry *= Math.PI/180;
			let m = new EulerRotation(0, ry, 0).toMatrix();
			let normal = m.mul(new Vec(0, 0, -1));
			for (let i=0; i<4; ++i) {
				let pos = m.mul(vPos[i]);
				vA.push(pos.x);
				vA.push(pos.y);
				vA.push(pos.z);
				vA.push(r);
				vA.push(g);
				vA.push(b);
				vA.push(uv[i].x);
				vA.push(uv[i].y);
				vA.push(normal.x);
				vA.push(normal.y);
				vA.push(normal.z);
			}
			vE.push(n + 0);
			vE.push(n + 1);
			vE.push(n + 2);
			vE.push(n + 0);
			vE.push(n + 2);
			vE.push(n + 3);
			n += 4;
		};
		addFace(0, 0.5, 1, 0);
		geometry.attrArray = new Float32Array(vA);
		geometry.element = new Int8Array(vE);
		return geometry;
	}

	function render() {
		ctx.clear();
		ctx.renderMesh(mesh, camera);
	}

	let program, material, mesh, camera, ctx, vShader, fShader, texture;
	let nLoads = 4;

	function ready() {
		if (--nLoads) return;
		program = new Program(vShader, fShader);
		material = new Material(program);
		material.addTexture(texture);
		mesh = new Mesh(createCubeGeometry(4), material);
		// mesh.localRotate(Math.PI/4, 0, Math.PI/4, "ZYX");
		mesh.translate(0, 0, 5);
		camera = new Camera(Math.atan(18/36), 16/9, 1, 72);
		ctx = new WebGL2Context();
		ctx.bindCanvas(document.querySelector("canvas"));
		ctx.bindTexture(texture);
		setInterval(function(){
			mesh.localRotate(0, 0.001, 0);
			render();
		}, 0);
	}

	window.addEventListener("load", function(){
		ready();
	});

	loadImg("box.png", img=>{
		texture = new Texture(img);
		ready();
	});

	loadShader("vertex.glsl", "vertex", shader=>{
		vShader = shader;
		ready();
	})

	loadShader("fragment.glsl", "fragment", shader=>{
		fShader = shader;
		ready();
	})

</script>